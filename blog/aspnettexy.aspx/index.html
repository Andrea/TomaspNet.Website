<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <title>Compiling Texy! with Phalanger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="This article describes how to compile Texy! with Phalanger and how to use the produced assembly in ASP.NET application written in C#.">
  <meta name="author" content="Tomas Petricek">

  <!-- Reference Foundation -->
  <link rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/css/foundation.css">
  <script src="cjs/vendor/custom.modernizr.js"></script>

  <!-- Reference custom CSS and tooltips -->
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/style.css" />
  <script type="text/javascript" src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.js"></script>
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.css" />
</head>
<body>

   <header id="top-header">
    <div class="row">
      <div class="twelve columns">
        <h1><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/">Tomas Petricek's blog</a></h1>
        <p>Writing about practical F# coding and programming language research</p>
      </div>
    </div>
  </header>

  <header class="top-bar-header">
    <div class="contain-to-grid sticky">
    <nav class="top-bar">

    <ul class="title-area">
      <li class="name"><h1><a href="#"></a></h1></li>
      <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
    <section class="top-bar-section">
      <ul class="right">
        <li><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/blog/index.html">Blog</a></li>
        <li><a href="http://functional-programming.net">Trainings</a></li>
        <li><a href="http://functional-programming.net">Books</a></li>
        <li><a href="http://lanyrd.com/profile/tomasp">Talks</a></li>
        <li><a href="http://www.cl.cam.ac.uk/~tp322">Research & Teaching</a></li>
      </ul>
    </section>

    </nav></div>
  </header>
  
  
<div class="row">
	<div class="large-8 columns main-content">
    <content>
      
<h1>Compiling Texy! with Phalanger</h1>
<p>Texy! [<a href="#texyphallinks">1</a>] is a convertor from text format (similar to formats used in some wiki applications) 
  to valid XHTML code written in PHP. The syntax is described at Texy! web page [<a href="#texyphallinks">2</a>]. Unfortunately, it is only in 
  Czech language, but the syntax is very straightforward, so you can understand it without learning Czech :-).
  In this article, I'll show how to compile Texy! using Phalanger and how to use it in another .NET application written in C#.</p>

<p>Phalanger has two compilation modes, <strong>legacy mode</strong> which is compatible with any existing PHP code and <strong>pure mode</strong> which has
  some additional restrictions, but provides much better result in terms of .NET interoperability. You can find more details
  in the article <em>Phalanger for .NET developers</em> at our website [<a href="#texyphallinks">3</a>]. For compiling Texy! I
  choose the <strong>pure mode</strong>, because this will produce assembly that is easy to use from C#. Texy! is also written in 
  elegant object oriented manner, so it won't be difficult to modify it to fulfil additional code restrictions.
  First, what we have to do to make Texy! compatible with the Phalanger pure mode? The restrictions are following:</p> 
<ul>
  <li>No global code is allowed (all code has to be placed in function or class member function)</li>
  <li>No inclusions are allowed (you have to specify all source files during compilation and files are merged automatically)</li>
</ul>

<h2>Compiling</h2>
<p>You can also use Phalanger Visual Studio Extensions if you don't want to compile it using command line. In this case create
  new <strong>Class Library</strong> Phalanger project and add all Texy! source files. If you want to use the command line,
  you can use the following command (you'll need to list all source files):</p>
<pre>phpc /target:dll /pure /lang:CLR texy.php (other php sources...)</pre>
<p>The <code>target</code> modifier specifies that Phalanger should produce .NET dll library, <code>pure</code> specifies
  that we're using pure compilation mode and finally, <code>lang:CLR</code> enables Phalanger language extensions that
  we will use (I'll talk about this later).</p>

<h2>Modifying Texy!</h2>
<p>If you try to compile it without any modifications, you'll get a few compiler errors consisting of the two kinds of errors.
  First error says <em>"inclusions are not allowed in the pure unit"</em> and the second says <em>"global code is not allowed in the pure unit"</em>.
  These two errors are caused by pure mode limitations descibed earlier, so we'll need to modify the source code a bit to meet
  this two rules. Fortunately, Texy! contains only a few lines of global code, so it won't be very difficult. Moreover most of the global code lines are
  the following code:</p>
<pre>if (!<span class="k">defined</span>(<span class="s">'TEXY'</span>)) <span class="k">die</span>();</pre>  
<p>This code is here to ensure that script is used correctly if included, so you can safely remove these lines. You can also remove all 
  includes from the <code>texy.php</code> file, because all source files are compiled together in pure mode. The includes in the source
  look like the following line:</p>
<pre><span class="k">equire_once</span> TEXY_DIR.<span class="s">'...some file....php'</span>;</pre>  
<p>We have to do one last modification to make the source code compile correctly. Texy! uses several constants that are defined mostly in <code>constants.php</code>.
  Two constants are in <code>texy.php</code> and finally there is one more line of global code in <code>html.php</code> file. To make
  Texy! compatible with the pure mode we will move all constants and initialization code to one global function:</p>
<pre>
<span class="k">function</span> initTexy()
{
  <span class="c">// from 'html.php'</span>
  TexyHtml::$valid = array_merge(TexyHtml::$block, TexyHtml::$inline);

  <span class="c">// from 'texy.php'</span>
  <span class="k">define</span>(<span class="s">'TEXY'</span>, <span class="s">'Version 1.2 for PHP5 $Revision: 45 $'</span>);
  <span class="c">/* there was also a TEXY_DIR constant, but you can ignore it,
  because it was used only for inclusions */</span>
	
  <span class="c">// from 'constants.php'</span>
  <span class="k">define</span>(<span class="s">'TEXY_CHAR'</span>, <span class="s">'A-Za-z\x86-\xff'</span>);
  <span class="c">/* ... more constants ... */</span>
}
</pre>  
<p>Now we have a function that performs the initialization and the source code can be successfuly compiled, but we'll do two little 
  tweaks to make it easilly usable from C#. First, we'll mark the <code>Texy</code> class (which is used by library users) with the
  <code>Export</code> attribute which instructs the compiler to generate class that can be used from languages other than PHP
  (this is part of the PHP/CLR extensions available in Phalanger):</p>
<pre>
[Export]
<span class="k">class</span> Texy
{
  <span class="c">/* .. class source .. */</span>
}
</pre>  
<p>The second tweak will be adding automatic call to the <code>initTexy</code> function to the <code>Texy</code> class
  constructor, so that the function doesn't need to be called manually. Because we want to call it only once for application
  we'll add static field to the class to indicate whether we already performed the initialization:</p>
<pre>
<span class="k">static private</span> $initalized = <span class="k">false</span>;

<span class="k">public function</span> __construct()
{
  if (!$initialized) { initTexy(); $initialized=<span class="k">true</span>; }
  <span class="c">/* ... rest of the constructor ... */</span>
}
</pre>  
<p>And that's all :-). If you compile the project now, you'll get assembly that can be simply used from any other .NET language!</p>
<h2>Using Texy! in C#</h2>
<p>To demonstrate using Texy! in C# application I wrote little ASP.NET demo. After creating new web application, we'll need to 
  copy the library produced by Phalanger to the <code>bin</code> directory, where ASP.NET automatically locates it. Now add the following
  controls to the <code>default.aspx</code>:</p>
<pre>
&lt;asp:TextBox Columns="60" Rows="10" runat="server" 
  ID="txtTexy" TextMode="MultiLine" /&gt;&lt;br /&gt;
&lt;asp:Button runat="server" ID="btnOk" OnClick="btnOk_Click" Text=" OK " /&gt;
&lt;hr /&gt;
&lt;asp:Literal runat="server" ID="ltrOutput" /&gt;
</pre>  
<p>In the code-behind file, we need to add event handler called when user clicks on the OK button:</p>
<pre>
<span class="k">protected void</span> btnOk_Click(<span class="k">object</span> sender, EventArgs e)
{
  <span class="c">// Create instance of Texy! parser</span>
  Texy t = <span class="k">new</span> Texy();
  <span class="c">// Call the 'process' method and cast result to string</span>
  <span class="k">string</span> parsed = (<span class="k">string</span>)t.process(txtTexy.Text);
  <span class="c">// Display parsed text using literal</span>
  ltrOutput.Text = parsed;
}
</pre>
<p>The demo application should be ready now! You can even examine all methods of the <code>Texy</code> class in the
  Visual Studio intellisense. The only overhead when calling PHP classes compiled using pure mode is that you 
  have to cast the returned object to the correct type due to the dynamic nature of PHP language. In PHP you can't
  specify what type method returns, so when Phalanger compiles member function to .NET it declares return
  and parameter types as the <code>object</code> type. </p>

<ul>
  <li>Try it now - <a href="http://php-compiler.net/demos/texy/default.aspx">Live ASP.NET + Texy! demo</a>
    [<a href="http://php-compiler.net/demos/texy/default.aspx" target="_blank">^</a>]</li>
  <li>Downlaod sources - <a href="/articles/aspnettexy/demos.zip">ASP.NET demo and modified Texy!</a> (139 kB)
    </li>
</ul>  

<h2>Limitations</h2>
<p>The biggest limitation of this example is the fact that you need FullTrust permission to execute the PHP code
  compiled using Phalanger, which means that you can't use this Texy! library on most of the shared webhostings.
  We're however examining options for removing this limitation. Second problem is that there are a few issues with
  regular expression functions in latest Phalanger build. All the bugs are fixed now, but it will take some time
  before we'll release next beta version (but we'll do the best we can!). If you don't want to wait you can 
  download Phalanger source code from the CodePlex and build it yourself.</p>

<h2>Links and references <a name="texyphallinks"></a></h2>
<ul>
  <li>[1] <a href="http://texy.info/">Texy! Homepage </a> [<a href="http://texy.info/" target="_blank">^</a>]</li>
  <li>[2] <a href="http://texy.info/cs/syntax">Texy! Syntax </a> [<a href="http://texy.info/cs/syntax" target="_blank">^</a>]</li>
  <li>[3] <a href="http://php-compiler.net/doku.php?id=core%3aphalanger_for_.net_developers">Phalanger for .NET developers</a> [<a href="http://php-compiler.net/doku.php?id=core%3aphalanger_for_.net_developers" target="_blank">^</a>]</li>
</ul>


    </content>

  </div>
  <div class="large-4 columns" id="right-bar">
    <script type="text/javascript">
      var monthNames =
        [ "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
      var d = new Date();
    </script>
    <div class="right-item" id="right-calendar">
      <h4>Calendar -  <script type="text/javascript">document.write(monthNames[d.getMonth()] + " " + d.getFullYear());</script></h4>
      <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/current.jpg" />
      <p>The calendar shows a new picture each month since 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2005">2005</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2006">2006</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2007">2007</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2008">2008</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2009">2009</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2010">2010</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2011">2011</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2012">2012</a>. <br />
        See the first photos of <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2013">2013</a>.
      </p>
    </div>

    <h3>Welcome!</h3>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/tomas.jpg" alt="Tomas Petricek" style="float:right;margin:10px 0px 10px 10px;" />
    <p>I'm an F# enthusiast, book author and a PhD student at the University of Cambridge.
      When offline, I enjoy traveling and taking pictures. You can find me at
      at <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a> or email 
      <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a>.
    </p>

    <h4>Trainings and consulting</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/skillsmatter.png" alt="Tomas Petricek" style="float:right;margin:15px 0px 10px 10px;" />
    <p>I run F# and functional programming courses in <strong>London</strong>
      and <strong>New York</strong> with SkillsMatter.
    </p>
    <ul>
      <li>Check out our <a href="http://skillsmatter.com/course/scala/tomas-petricek-phil-trelford-fast-track-to-fsharp/ps-6679">Fast Track to F#</a> course</li>
      <li><a href="mailto:tomas@tomasp.net">Email me</a> for info about private trainings</li>
    </ul>
    
    <h4>F# Books and articles</h4>
    <div style="float:right;">
      <a href="http://www.amazon.com/gp/product/1933988924/ref=as_li_tf_il?ie=UTF8&amp;tag=httptomasnet-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399369&amp;creativeASIN=1933988924">
        <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/rwfp.jpg" alt="Real World Functional Programming" style="float:right;margin:10px 0px 10px 10px;border-style:none;" />
      </a>
    </div>
    <p><a href="http://www.manning.com/petricek">Real World Functional Programming</a> explains functional
      concepts using F# and C#. You can get it from <a href="http://www.amazon.com/dp/1933988924?tag=httptomasnet-20&amp;camp=213381&amp;creative=390973&amp;linkCode=as4&amp;creativeASIN=1933988924&amp;adid=0F1DP260JGG4KY0CDGP6">Amazon.com</a>, <a href="https://www.amazon.co.uk/dp/1933988924?tag=tomasnet-21&amp;camp=1406&amp;creative=6394&amp;linkCode=as1&amp;creativeASIN=1933988924&amp;adid=1CTY87YCCQEJW965GNDF">Amazon.co.uk</a> or your favorite book store.
      Some chapters and new materials are also available on <a href="http://msdn.microsoft.com/en-us/library/hh314518.aspx">MSDN</a>.</p>
    
    <p>Currently, I'm putting together <a href="http://www.manning.com/petricek2/">F# Deep Dives</a> - a collection
      of practical F# essays written by community leaders and commercial users of F#.</p>
    <p>I also wrote a series of tutorials on <a href="http://www.tryfsharp.org/Learn/financial-computing">financial computing</a>
      for Try F# - an interactive environment that let's you try F# in the browser.</p>

    <h4>Research and teaching</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/cam.png" alt="University of Cambride" style="float:right;margin:25px 0px 10px 10px;" />
    <p>I'm finishing PhD in computer science at the <a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>.
      I'm working on making better types for programs that run in rich context (like F# type providers, distributed 
      prog&shy;ramming or data-flow). See <a href="http://www.cl.cam.ac.uk/~tp322/">my academic page</a> for
      more.</p>

  </div>
</div>


  <footer>
    tomas
  </footer>

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/zepto' : 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
</body>
</html>
<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <title>F# metaprogramming and classes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="This article presents prototype that makes it possible to use F# metaprogramming to analyse and translate classes written in special way. ">
  <meta name="author" content="Tomas Petricek">

  <!-- Reference Foundation -->
  <link rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/css/foundation.css">
  <script src="cjs/vendor/custom.modernizr.js"></script>

  <!-- Reference custom CSS and tooltips -->
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/style.css" />
  <script type="text/javascript" src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.js"></script>
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.css" />
</head>
<body>

   <header id="top-header">
    <div class="row">
      <div class="twelve columns">
        <h1><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/">Tomas Petricek's blog</a></h1>
        <p>Writing about practical F# coding and programming language research</p>
      </div>
    </div>
  </header>

  <header class="top-bar-header">
    <div class="contain-to-grid sticky">
    <nav class="top-bar">

    <ul class="title-area">
      <li class="name"><h1><a href="#"></a></h1></li>
      <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
    <section class="top-bar-section">
      <ul class="right">
        <li><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/blog/index.html">Blog</a></li>
        <li><a href="http://functional-programming.net">Trainings</a></li>
        <li><a href="http://functional-programming.net">Books</a></li>
        <li><a href="http://lanyrd.com/profile/tomasp">Talks</a></li>
        <li><a href="http://www.cl.cam.ac.uk/~tp322">Research & Teaching</a></li>
      </ul>
    </section>

    </nav></div>
  </header>
  
  
<div class="row">
	<div class="large-8 columns main-content">
    <content>
      
<h1>F# metaprogramming and classes</h1>




<h2>Introduction</h2>
<p>F# quotations allows you to easily write programs that manipulate with data representation
  of program source code. If you're not familiar with quotations I recommend reading my 
  previous article [<a href="#fsclassmeta-links">1</a>] that contains short introduction
  to this topic first. Quotations can be used for example for translating subset of the F# language to 
  another code representation or another language.</p>
  
<p>To get the quotation data of the expression you can either use <code>&lt;@ .. @&gt;</code> 
  operator or <code>resolveTopDef</code> function. In the first case the code written
  between the "<code>&lt;@</code>" and "<code>@&gt;</code>" is converted to data during the compilation.
  The <code>resolveTopDef</code> function allows you to get quotation data of top-level 
  definition (function) from compiled library at runtime (you have to use <code>--quotation-data</code> 
  command line switch while compiling the library). I mentioned that quotations can be used to represent 
  only subset of the F# language. Currently, one of the quotation limitations is that it's not possible to 
  enclose the whole class in the quotation operators. It is also not possible to get the representation 
  of the whole class at runtime nor the representation of class members (for example methods). </p>

<h2>Class quotations</h2>

<p>In one my project I wanted to be able to translate the class written in F# to another language,
  so I wanted to make this possible. This option will be probably implemented in the future versions
  of F#, so it will be possible to do this using more elegant method, but if you want to experiment
  with quotations and use classes, you can use my solution to implement the prototype.</p>

<p>In the prototype I implemented, you have to write the class and one module that contains 
  the actual code for the methods. This makes it possible to get the structure of the class using
  standard .NET reflection classes and to extract quotation data for the class members using
  F# <code>resolveTopDef</code> function. Of course, you can't create instance of module, but for metaprogramming
  we only need to be able to get the quoted code and unless you want to use the class from code, you can leave
  the implementation of the class methods empty.</p>

<p>First I had to design the data structures for representing the class. If I were adding this feature to the F# 
  metaprogramming, I would probably extended the <code>expr</code> data type to make this possible in
  consistent way. However I didn't want to modify the F# source code, so I designed the following types
  that are similar to the <code>expr</code> type (I reversed the order of type declarations, so it 
  is easier to understand):</p>
<pre>
<span class="c">/// Structure that contains information about class -
/// consists of name, name of base class and members</span><br />
<span class="k">type</span> classInfo = {
  name:string;
  baseName:string option;
  members:classMember list;
};;

<span class="c">/// Member of the class 
/// For working with this type use cmfCtor, cmfMethod, cmfField, cmfProp..</span><br />
<span class="k">type</span> classMember;;

<span class="c">/// Type for working with class members
/// Query function tests whether member is of specified type
/// Make function creates member</span><br />
<span class="k">type</span> 'a classMemberFamily <span class="k">with</span><br />
  <span class="k">member</span> Query : classMember -&gt; 'a option
  <span class="k">member</span> Make : 'a -&gt; classMember
<span class="k">end</span>;;

<span class="c">/// Constructor declaration 
/// - parameter should be lambda expression</span><br />
<span class="k">val</span> cmfCtor : (expr) classMemberFamily;;
	
<span class="c">/// Method delcaration
/// - method name, expression (should be lambda) and return type
///   (types of parameters are stored in lambda expression)</span><br />
<span class="k">val</span> cmfMethod : (string*expr*Type option) classMemberFamily;;
	
<span class="c">/// Field declaration
/// - field name, type and init expression</span><br />
<span class="k">val</span> cmfField : (string*Type*expr option) classMemberFamily;;
	
<span class="c">/// Property declaration
/// - property name, getter and setter (both should be lambda expr) and type</span><br />
<span class="k">val</span> cmfProp : (string*expr*expr*Type) classMemberFamily;;
</pre>

<p>This representation is still very limited - for example it isn't possible to represent
  polymorphic methods. In the previous code, the <code>classMember</code> can be used to 
  represent any member (similarly to the F# <code>expr</code> that can represent any expression).
  The <code>cmf[Something]</code> values are equivalent to the 
  <code>ef[Something]</code> from F# quotation library and allows you to work with
  <code>classMember</code> type.</p>
  
<p>The following example shows how to write simple class with module that can be used for extracting 
  the quotation data:</p>
<pre>
#light

<span class="c">// Module with implementation of methods</span><br />
<span class="k">module</span> Person_Meta = <span class="k">begin</span>
  <span class="c">// Simulates field of the class</span>
  <span class="k">let</span> name = <span class="k">ref</span> ""
  
  <span class="c">// Represents constructor</span>
  <span class="k">let</span> ctor (n) =
    name := n
    
  <span class="c">// Represents method</span>
  <span class="k">let</span> Say (pre:string) =
    let s = pre^", my name is "^(!name)^"." in
    print_string s
  
  <span class="c">// Represents property  </span>
  <span class="k">let</span> get_Name () =
    (!name)
  <span class="k">let</span> set_Name (value) =
    name:=value
<span class="k">end</span>
 <br /><br /> 
<span class="c">// The real class
// Members are just a placeholders and the quotations
// are extracted from the previous module</span><br />
<span class="k">type</span> Person = <span class="k">class </span><br />
  <span class="k">val mutable</span> name : string;
  <span class="k">new</span>((n:string)) = { name = ""; }
  <span class="k">member</span> this.Say(pre:string) = ()
  <span class="k">member</span> this.Name with get() = "" <span class="k">and</span> set((v:string)) = ()
<span class="k">end</span>
</pre>  

<p>In the last code sample, I'll show how the functions I wrote can be used for working 
  with the previous piece of code. To get the representation that I mentioned earlier of
  the class <code>Person</code>, you can use function <code>getClassFromType</code>. This function
  extracts structure of the class (from the class itself) and quoted code from the module
  with the <code>_Meta</code> suffix. The following example is quite simple. It prints
  basic class information (name and base name) and then iterates through all the members and
  prints all available information for every member. For printing the <code>expr</code> type
  (which represents the quoted code) I used <code>printf</code> function with the <code>output_any</code> formatter.</p>

<pre>
#light
<span class="k">do</span><br />
  <span class="c">// Get the class info for class 'Person'</span><br />
  <span class="k">let</span> clsInfo = getClassFromType ((typeof() : Person typ).result)
  
  <span class="c">// Print name and optional base name</span>
  Console.WriteLine(<span class="s">"Class '{0}':"</span>, clsInfo.name)
  <span class="k">if</span> (clsInfo.baseName &lt;&gt; None) <span class="k">then</span>
    Console.WriteLine(<span class="s">" base: {0}"</span>, clsInfo.baseName)
  
  <span class="c">// Iterate through class members</span>
  clsInfo.members |&gt; List.iter ( <span class="k">fun</span> m -&gt;
      <span class="k">match</span> cmfMethod.Query m <span class="k">with</span>
        | Some (name, expr, ret) -&gt;
            Method <span class="s">"printf ( %s : %a ) = "</span> name output_any ret
        | _ -&gt;
      <span class="k">match</span> cmfField.Query m <span class="k">with</span>
        | Some (name, typ, init) -&gt;
            printf <span class="s">"Field ( %s : %a) "</span> name output_any typ
        | _ -&gt;
      <span class="k">match</span> cmfProp.Query m <span class="k">with</span>
        | Some (name, getter, setter, typ) -&gt;
            printf <span class="s">"Property ( %s : %a )\n"</span> name output_any typ
            printf <span class="s">"get = %a\n"</span> output_any getter
            printf <span class="s">"set = %a\n\n"</span> output_any setter
        | _ -&gt;
      <span class="k">match</span> cmfCtor.Query m <span class="k">with</span>
        | Some (expr) -&gt;
            printf <span class="s">"Ctor = %a\n\n"</span> output_any expr
        | _ -&gt;
            failwith <span class="s">"Error!"</span>
    ) 
</pre>

<h2>Conclusion</h2>
<p>The aim of this article isn't to present fully working solution, but to suggest a few enhancements
  to the F# metaprogramming that I think would be useful. You can use the source code attached to this 
  article to find (and experiment with) some interesting use cases of metaprogramming that require working 
  with classes, for example translating classes written in F# to another language. The biggest limitation
  of the solution I presented is, that you have to write every implementation twice - it occurs in the
  body of the class and in the module used for metaprogramming too (however the code looks very similar).
  If you want to translate F# code, you don't need to implement methods/properties of the real class, but
  if the program creates instances of the class at runtime (and uses the quoted code to perform some analysis etc.),
  you'll need to write both implementations.</p>

<h2>Downloads</h2>
<ul>
  <li><a href="http://www.tomasp.net/articles/fsclassmeta/source.zip">Download the source code and examples</a> (6.77kB)</li>
  <li><a href="http://www.tomasp.net/articles/fsclassmeta/article.pdf">Download the article</a> (pdf, 204kB)</li>
</ul>

<h2>Links and references<a name="fsclassmeta-links"></a></h2>
<ul>
  <li>[1] <a href="http://cs.hubfs.net/blogs/tomasp/archive/2006/07/07/413.aspx">F# - Simple quotations transformation</a>
    [<a href="http://cs.hubfs.net/blogs/tomasp/archive/2006/07/07/413.aspx" target="_blank">^</a>] - My F# Notes</li>  
</ul>





    </content>

  </div>
  <div class="large-4 columns" id="right-bar">
    <script type="text/javascript">
      var monthNames =
        [ "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
      var d = new Date();
    </script>
    <div class="right-item" id="right-calendar">
      <h4>Calendar -  <script type="text/javascript">document.write(monthNames[d.getMonth()] + " " + d.getFullYear());</script></h4>
      <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/current.jpg" />
      <p>The calendar shows a new picture each month since 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2005">2005</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2006">2006</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2007">2007</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2008">2008</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2009">2009</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2010">2010</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2011">2011</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2012">2012</a>. <br />
        See the first photos of <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2013">2013</a>.
      </p>
    </div>

    <h3>Welcome!</h3>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/tomas.jpg" alt="Tomas Petricek" style="float:right;margin:10px 0px 10px 10px;" />
    <p>I'm an F# enthusiast, book author and a PhD student at the University of Cambridge.
      When offline, I enjoy traveling and taking pictures. You can find me at
      at <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a> or email 
      <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a>.
    </p>

    <h4>Trainings and consulting</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/skillsmatter.png" alt="Tomas Petricek" style="float:right;margin:15px 0px 10px 10px;" />
    <p>I run F# and functional programming courses in <strong>London</strong>
      and <strong>New York</strong> with SkillsMatter.
    </p>
    <ul>
      <li>Check out our <a href="http://skillsmatter.com/course/scala/tomas-petricek-phil-trelford-fast-track-to-fsharp/ps-6679">Fast Track to F#</a> course</li>
      <li><a href="mailto:tomas@tomasp.net">Email me</a> for info about private trainings</li>
    </ul>
    
    <h4>F# Books and articles</h4>
    <div style="float:right;">
      <a href="http://www.amazon.com/gp/product/1933988924/ref=as_li_tf_il?ie=UTF8&amp;tag=httptomasnet-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399369&amp;creativeASIN=1933988924">
        <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/rwfp.jpg" alt="Real World Functional Programming" style="float:right;margin:10px 0px 10px 10px;border-style:none;" />
      </a>
    </div>
    <p><a href="http://www.manning.com/petricek">Real World Functional Programming</a> explains functional
      concepts using F# and C#. You can get it from <a href="http://www.amazon.com/dp/1933988924?tag=httptomasnet-20&amp;camp=213381&amp;creative=390973&amp;linkCode=as4&amp;creativeASIN=1933988924&amp;adid=0F1DP260JGG4KY0CDGP6">Amazon.com</a>, <a href="https://www.amazon.co.uk/dp/1933988924?tag=tomasnet-21&amp;camp=1406&amp;creative=6394&amp;linkCode=as1&amp;creativeASIN=1933988924&amp;adid=1CTY87YCCQEJW965GNDF">Amazon.co.uk</a> or your favorite book store.
      Some chapters and new materials are also available on <a href="http://msdn.microsoft.com/en-us/library/hh314518.aspx">MSDN</a>.</p>
    
    <p>Currently, I'm putting together <a href="http://www.manning.com/petricek2/">F# Deep Dives</a> - a collection
      of practical F# essays written by community leaders and commercial users of F#.</p>
    <p>I also wrote a series of tutorials on <a href="http://www.tryfsharp.org/Learn/financial-computing">financial computing</a>
      for Try F# - an interactive environment that let's you try F# in the browser.</p>

    <h4>Research and teaching</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/cam.png" alt="University of Cambride" style="float:right;margin:25px 0px 10px 10px;" />
    <p>I'm finishing PhD in computer science at the <a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>.
      I'm working on making better types for programs that run in rich context (like F# type providers, distributed 
      prog&shy;ramming or data-flow). See <a href="http://www.cl.cam.ac.uk/~tp322/">my academic page</a> for
      more.</p>

  </div>
</div>


  <footer>
    tomas
  </footer>

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/zepto' : 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
</body>
</html>
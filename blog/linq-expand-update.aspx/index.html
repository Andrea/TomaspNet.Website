<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <title>LINQ extensions - Simplified keyword search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Article describes LINQ extension that adds support for returning rows that contain any or all of specified keywords in string column.">
  <meta name="author" content="Tomas Petricek">

  <!-- Reference Foundation -->
  <link rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/css/foundation.css">
  <script src="cjs/vendor/custom.modernizr.js"></script>

  <!-- Reference custom CSS and tooltips -->
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/style.css" />
  <script type="text/javascript" src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.js"></script>
  <link type="text/css" rel="stylesheet" href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/custom/tooltips.css" />
</head>
<body>

   <header id="top-header">
    <div class="row">
      <div class="twelve columns">
        <h1><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/">Tomas Petricek's blog</a></h1>
        <p>Writing about practical F# coding and programming language research</p>
      </div>
    </div>
  </header>

  <header class="top-bar-header">
    <div class="contain-to-grid sticky">
    <nav class="top-bar">

    <ul class="title-area">
      <li class="name"><h1><a href="#"></a></h1></li>
      <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
    <section class="top-bar-section">
      <ul class="right">
        <li><a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/blog/index.html">Blog</a></li>
        <li><a href="http://functional-programming.net">Trainings</a></li>
        <li><a href="http://functional-programming.net">Books</a></li>
        <li><a href="http://lanyrd.com/profile/tomasp">Talks</a></li>
        <li><a href="http://www.cl.cam.ac.uk/~tp322">Research & Teaching</a></li>
      </ul>
    </section>

    </nav></div>
  </header>
  
  
<div class="row">
	<div class="large-8 columns main-content">
    <content>
      
<h1>LINQ extensions - Simplified keyword search</h1>


<p>Recently, I came across interesting question at LINQ Forums (Dynamic conditions: How to achieve multiple "OR" conditions with LINQ? [<a href="#updlq">1</a>]).
  The question is whether LINQ (and especially LINQ to SQL) provides any simple way to return only records that contain one or more of 
  specified keywords in the name. The question looks simple, but it is simple only if you know the number of keywords that you want to 
  look for. In this case you can write following LINQ query:</p>
<pre>
  <span class="c">// Products that contain "kwd1" or "kwd2" in the name </span><br />
  <span class="k">var</span> q = <span class="k">from</span> p <span class="k">in</span> db.Products
    <span class="k">where</span> p.ProductName.Contains("kwd1") || p.ProductName.Contains("kwd2")
    <span class="k">select</span> p;
</pre>
<p>The problem with previous code is that you can't use it if the list of keywords is dynamically entered by user
  (and so its length may vary). Of course, if you want to run query on in-memory data, you can get very nice results by
  writing extension method called <code>ContainsAny</code> that performs test for keyword array, but if you 
  want to be able to translate query to SQL, the situation is a bit complicated.</p>

<h2>Building expression tree</h2>
<p>The first solution is to build the whole expression tree that is used for filtering (in the <code>where</code> clause)
  using <code>Expression</code> object. The code that builds expression tree is much longer, because it must generate
  expression for calling method <code>Contains</code> for every keyword in the array. The following example shows how
  to build test for only two keywords for simplicity:</p>
<pre>
<span class="c">// build as many conditions as you need</span>
Expression t1 = Expression.CallVirtual(
   <span class="k">typeof</span>(<span class="k">string</span>).GetMethod("Contains"),
   Expression.Property(p, typeof(Product).GetProperty("ProductName")),
   <span class="k">new</span> Expression[] { Expression.Constant("Chef") });
Expression t2 = Expression.CallVirtual(
   <span class="k">typeof</span>(<span class="k">string</span>).GetMethod("Contains"), 
   Expression.Property(p, typeof(Product).GetProperty("ProductName")),
   <span class="k">new</span> Expression[] { Expression.Constant("Sir") });

<span class="c">// merge conditions using Expression.Or</span>
<br /><span class="k">var</span> test = Expression.Lambda&lt;Func&lt;Product, bool&gt;&gt;
  (Expression.Or(t1, t2), <span class="k">new</span> ParameterExpression[] { p });
<span class="k">var</span> filter = Queryable.Where(db.Products, test);

<span class="c">// Execute the query</span><br />
<span class="k">var</span> q = <span class="k">from</span> prod <span class="k">in</span> filter
   <span class="k">select</span> prod;
</pre>

<p>You might also think of using <code>Queryable.Union</code> method that returns union of results
  from several queries. Generating query using this method is possible and the code is less
  complicated, but the resulting SQL command generated by the LINQ to SQL is very poor and 
  it would be obviously slower. That's definitely not an issue in LINQ, because the query created using
  <code>Union</code> is very far from natural query that you would normally use.</p>

<h2>Better solution</h2>
<p>The previous solution can be used for generating any expression tree, so there will be always 
  certain situations, when this would be the only possible way, however I think that these two methods
  (<code>ContainsAny</code> and <code>ContainsAll</code>) will be used very often. I already wrote
  an extension to LINQ that allows you to 'call' expression tree in query [<a href="#updlq">3</a>], so I used this project
  and I added support for the following two methods:</p>
<pre>
<span class="k">using</span> EeekSoft.Query;

<span class="c">// Select products, that conain one of values from array in their name</span><br />
<span class="k">var</span> q1 = <span class="k">from</span> p <span class="k">in</span> db.Products.<b>ToExpandable()</b><br />
    <span class="k">where</span> p.ProductName.<b>ContainsAny("Sir", "Chef")</b><br />
    <span class="k">select new</span> { p.ProductName };

<span class="c">// Select products, that conain all of values from array in their name</span><br />
<span class="k">var</span> q1 = <span class="k">from</span> p <span class="k">in</span> db.Products.<b>ToExpandable()</b><br />
    <span class="k">where</span> p.ProductName.<b>ContainsAll("Gu", "Ca")</b><br />
    <span class="k">select new</span> { p.ProductName };
</pre>
<p>To be able to write this code, you have to download the library <code>EeekSoft.Query</code> first. [See <a href="#updlq">Downloads</a>]</p>

<h2>How does it work?</h2>
<p>I already described the method that I used here for extending the LINQ in my previous article [<a href="#updlq">3</a>], so 
  you can refer to it for more details. The important point is the call to the <code>ToExpandable</code> extension method.
  This method returns <code>IQueryable</code> wrapper around the original data source (data table in this case).
  When query is executed, this wrapper is called and it modifies the expression tree before it is passed to LINQ to SQL
  converter, so the methods like <code>ContainsAny</code> are replaced with some other expression that the LINQ to SQL 
  can understand.</p>

<h2>References and downloads<a name="updlq"></a></h2>
<ul class="ref">
  <li><a href="http://tomasp.net/articles/linq-expand-update/demos.zip">Download code samples</a> (29kB)</li>
</ul>
<ul class="ref">
  <li>[1] <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=582495">Dynamic conditions: How to achieve multiple "OR" conditions with LINQ?</a>
    [<a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=582495" target="_blank">^</a>] - LINQ Project General - MSDN Forums (by marcioesteves)</li>  
  <li>[2] <a href="http://msdn.microsoft.com/data/ref/linq/">The LINQ Project</a>
    [<a href="http://msdn.microsoft.com/data/ref/linq/" target="_blank">^</a>] - Microsoft.com</li>
  <li>[3] <a href="http://tomasp.net/blog/linq-expand.aspx">Calling functions in LINQ queries</a>
    [<a href="http://tomasp.net/blog/linq-expand.aspx" target="_blank">^</a>] - Tomasp.net</li>
</ul>



    </content>

  </div>
  <div class="large-4 columns" id="right-bar">
    <script type="text/javascript">
      var monthNames =
        [ "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
      var d = new Date();
    </script>
    <div class="right-item" id="right-calendar">
      <h4>Calendar -  <script type="text/javascript">document.write(monthNames[d.getMonth()] + " " + d.getFullYear());</script></h4>
      <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/current.jpg" />
      <p>The calendar shows a new picture each month since 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2005">2005</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2006">2006</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2007">2007</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2008">2008</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2009">2009</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2010">2010</a>, 
        <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2011">2011</a>, <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2012">2012</a>. <br />
        See the first photos of <a href="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/calendar/2013">2013</a>.
      </p>
    </div>

    <h3>Welcome!</h3>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/tomas.jpg" alt="Tomas Petricek" style="float:right;margin:10px 0px 10px 10px;" />
    <p>I'm an F# enthusiast, book author and a PhD student at the University of Cambridge.
      When offline, I enjoy traveling and taking pictures. You can find me at
      at <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a> or email 
      <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a>.
    </p>

    <h4>Trainings and consulting</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/skillsmatter.png" alt="Tomas Petricek" style="float:right;margin:15px 0px 10px 10px;" />
    <p>I run F# and functional programming courses in <strong>London</strong>
      and <strong>New York</strong> with SkillsMatter.
    </p>
    <ul>
      <li>Check out our <a href="http://skillsmatter.com/course/scala/tomas-petricek-phil-trelford-fast-track-to-fsharp/ps-6679">Fast Track to F#</a> course</li>
      <li><a href="mailto:tomas@tomasp.net">Email me</a> for info about private trainings</li>
    </ul>
    
    <h4>F# Books and articles</h4>
    <div style="float:right;">
      <a href="http://www.amazon.com/gp/product/1933988924/ref=as_li_tf_il?ie=UTF8&amp;tag=httptomasnet-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399369&amp;creativeASIN=1933988924">
        <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/rwfp.jpg" alt="Real World Functional Programming" style="float:right;margin:10px 0px 10px 10px;border-style:none;" />
      </a>
    </div>
    <p><a href="http://www.manning.com/petricek">Real World Functional Programming</a> explains functional
      concepts using F# and C#. You can get it from <a href="http://www.amazon.com/dp/1933988924?tag=httptomasnet-20&amp;camp=213381&amp;creative=390973&amp;linkCode=as4&amp;creativeASIN=1933988924&amp;adid=0F1DP260JGG4KY0CDGP6">Amazon.com</a>, <a href="https://www.amazon.co.uk/dp/1933988924?tag=tomasnet-21&amp;camp=1406&amp;creative=6394&amp;linkCode=as1&amp;creativeASIN=1933988924&amp;adid=1CTY87YCCQEJW965GNDF">Amazon.co.uk</a> or your favorite book store.
      Some chapters and new materials are also available on <a href="http://msdn.microsoft.com/en-us/library/hh314518.aspx">MSDN</a>.</p>
    
    <p>Currently, I'm putting together <a href="http://www.manning.com/petricek2/">F# Deep Dives</a> - a collection
      of practical F# essays written by community leaders and commercial users of F#.</p>
    <p>I also wrote a series of tutorials on <a href="http://www.tryfsharp.org/Learn/financial-computing">financial computing</a>
      for Try F# - an interactive environment that let's you try F# in the browser.</p>

    <h4>Research and teaching</h4>
    <img src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/img/cam.png" alt="University of Cambride" style="float:right;margin:25px 0px 10px 10px;" />
    <p>I'm finishing PhD in computer science at the <a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>.
      I'm working on making better types for programs that run in rich context (like F# type providers, distributed 
      prog&shy;ramming or data-flow). See <a href="http://www.cl.cam.ac.uk/~tp322/">my academic page</a> for
      more.</p>

  </div>
</div>


  <footer>
    tomas
  </footer>

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/zepto' : 'file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="file:///C:/Tomas/Projects/WebSites/TomaspNet.New/output/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
</body>
</html>